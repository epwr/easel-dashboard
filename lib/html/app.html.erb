<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>
      <%= $config[:title] %>
    </title>
    <link rel="stylesheet" href="/app.css">
    <script type="text/javascript">

        // TODO: Add a RUN and STOP variable, that point to a div as a play button
        // or a square.
        let ws_socket = new WebSocket("ws://" + location.hostname + ":" + location.port);
        let current_cmd = null;
        let keep_pane_contents = false; // Remove default contents when you run a command.

        let streams = { <%$config[:commands].each do |command|%>
          <%= command[:id] %>: { is_running: false,  content: "", name: "<%= command[:name] %>" },<% end %>
        };

        // Receive message
        ws_socket.onmessage = (event) => {

          pane = document.getElementById('output-pane');
          console.log("Received: " + event.data);

          // Clear pane if appropriate
          if (!keep_pane_contents) {
            pane.innerHTML = "";
            keep_pane_contents = true;
          }

          // Split message into [ID, CMD, MSG]
          msg_frags = event.data.split(":");
          id = msg_frags[0];
          cmd_type = msg_frags[1];
          msg = msg_frags.slice(2).join(":");


          // Validate
          if (!(id in streams) || !(["ERR", "OUT", "CLEAR", "FINISHED"].includes(cmd_type)) ) {
            console.log("Error validating message: " + events.data);
            return;
          }

          // Process message
          switch (cmd_type) {
            case "ERR":
              append_stream_content(id, "<span class=\"stderr\">" + msg + "</span>");
              break;
            case "OUT":
              append_stream_content(id, msg);
              break;
            case "CLEAR":
              streams[id]['content'] = "";
              update_pane();
              break;
            case "FINISHED":
              document.getElementById('cmd-' + id + '-run-icon').innerHTML = "Run";
              streams[id]['is_running'] = false;
              update_pane();
              break;
            default:
              console.log("Error: Message not understood. Id: " + id + ", cmd_type: " + cmd_type + ", msg:" + msg);
          }
        }

        // append_stream_content
        function append_stream_content(id, content){
          console.log("Id: " + id + ", current_cmd: " + current_cmd + ", content: " + content);
          streams[id]['content'] += content;
          update_pane();
        }

        function toggle_run(id){
          if (streams[id]['is_running']) { // STOP (already running)
            ws_socket.send("STOP:" + id);
            document.getElementById('cmd-' + id + '-run-icon').innerHTML = "Run";
          } else { // RUN (currently not running)
            streams[id]['content'] = "";
            ws_socket.send("RUN:" + id);
            document.getElementById('cmd-' + id + '-run-icon').innerHTML = "Stop";
            current_cmd = id;
          }
          streams[id]['is_running'] = !streams[id]['is_running'];
          update_pane();
        }

        function load_pane(id) {
          current_cmd = id;
          update_pane();
        }

        function update_pane() {
          pane = document.getElementById('output-pane');
          pane_state = document.getElementById('interface-state');
          pane_state_details = document.getElementById('interface-state-details');

          pane.innerHTML = streams[current_cmd]['content'];
          if (streams[current_cmd]['is_running']) {
            pane_state.innerHTML = "Running: ";
          } else {
            pane_state.innerHTML = "Output Of: ";
          }
          pane_state_details.innerHTML = streams[current_cmd]['name'];
        }

        function show_help_message() {
          current_cmd = null;
          pane = document.getElementById('output-pane');
          pane_state = document.getElementById('interface-state');
          pane_state_details = document.getElementById('interface-state-details');


          pane.innerHTML =
            "Welcome to the CDash Dashboard! Programs are set up via a YAML file on the server.\n\n" +
            "You can run these programs by clicking 'Run' under a program's information.\n\n" +
            "Programs' output will update even if you are looking at the output of another program.\n\n" +
            "Use the 'Show' button to select which programs' output you are seeing.";
          pane_state.innerHTML = "Showing: ";
          pane_state_details = "Help Message";
        }

    </script>
  </head>
  <body>
    <div class="screen">
      <div class="cmd-picker">

        <% $config[:commands].each do |command| %>
          <div class="command-box">
            <div class="command-info"
              onclick="load_pane(<%=command[:id]%>)"
              id="cmd-<%=command[:id]%>"
              data-id="<%=command[:id]%>"
              data-cmd="<%=command[:cmd]%>">
              <h2><%= command[:name] %></h2>
              <p><%= command[:desc] %></p>
            </div>
            <div class="command-controls">
              <div class="command-icon"
                id="cmd-<%=command[:id]%>-run-icon"
                onclick="toggle_run(<%= command[:id] %>)">
                Run
              </div>
              <div class="command-icon"
                id="cmd-<%=command[:id]%>-log-icon"
                onclick="load_pane(<%=command[:id]%>)">
                Show
              </div>
            </div>
          </div>
        <% end %>
      </div>
      <div class="interface surface">
        <div id="interface-title">
          <span class="h2" id="interface-state">Waiting:</span>
          <span id="interface-state-details"></span>
        </div>
        <div class="interface-output scroll-content">
          <pre class="output-pane" id="output-pane">Click 'Run' to run a command and see it's output.

Click 'Help' (below) to see more.</pre>
        </div>
        <div class="interface-footer">
          <div class="interface-commands">
            <div class="top-shadow"></div>
            <div class="interface-button"
              onclick="show_help_message()">
              Help
            </div>
            <div class="interface-button"
              onclick="console.log('Save output button has not been implemented.')">
              Save Output
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
